name: Build Valheim DLL

on:
  workflow_dispatch:  # manuelles Starten

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1️⃣ Repo auschecken
      - uses: actions/checkout@v4

      # 2️⃣ Temp-Verzeichnis erstellen
      - name: Create temp folder
        shell: powershell
        run: mkdir C:\vtemp

      # 3️⃣ SteamCMD sauber installieren (komplett löschen & neu)
      - name: Install SteamCMD
        shell: powershell
        run: |
          if (Test-Path "C:\vtemp\steamcmd") {
              Remove-Item -Path "C:\vtemp\steamcmd" -Force -Recurse
          }
          mkdir -p C:\vtemp\steamcmd
          
          Write-Host "Downloading SteamCMD..."
          Invoke-WebRequest -Uri "https://steamcdn-a.akamaihd.net/client/installer/steamcmd.zip" -OutFile "C:\vtemp\steamcmd\steamcmd.zip" -ErrorAction Stop
          
          Write-Host "Extracting SteamCMD..."
          Expand-Archive -Path "C:\vtemp\steamcmd\steamcmd.zip" -DestinationPath "C:\vtemp\steamcmd" -Force
          
          Write-Host "Cleaning up..."
          Remove-Item "C:\vtemp\steamcmd\steamcmd.zip" -Force
          
          # Verify extraction
          if (Test-Path "C:\vtemp\steamcmd\steamcmd.exe") {
              Write-Host "✓ SteamCMD installed successfully"
          } else {
              Write-Host "##[error]steamcmd.exe not found after extraction"
              exit 1
          }

      # 4️⃣ SteamCMD initialisieren mit Retry und besserer Fehlerbehandlung
      - name: Run SteamCMD once
        shell: powershell
        run: |
          $maxAttempts = 3
          for ($i = 1; $i -le $maxAttempts; $i++) {
              Write-Host "==> SteamCMD initialization attempt $i/$maxAttempts..."
              cd C:\vtemp\steamcmd
              
              # Logs-Verzeichnis sicherstellen
              if (-not (Test-Path "C:\vtemp\steamcmd\logs")) {
                  mkdir "C:\vtemp\steamcmd\logs"
              }
              
              ./steamcmd.exe +login anonymous +quit
              $exitCode = $LASTEXITCODE
              
              if ($exitCode -eq 0) {
                  Write-Host "✓ SteamCMD initialization successful"
                  Start-Sleep 3
                  exit 0
              }
              
              Write-Host "##[warning]SteamCMD initialization failed with exit code $exitCode"
              
              if (Test-Path "C:\vtemp\steamcmd\logs\stderr.txt") {
                  Get-Content -Path "C:\vtemp\steamcmd\logs\stderr.txt" | Write-Host
              }
              
              if ($i -lt $maxAttempts) {
                  Write-Host "==> Waiting 15 seconds before retry..."
                  Start-Sleep -Seconds 15
              } else {
                  Write-Host "##[error]SteamCMD initialization failed after $maxAttempts attempts with exit code $exitCode"
                  exit 1
              }
          }

      # 5️⃣ Valheim Dedicated Server installieren / updaten mit Retry
      - name: Install Valheim Server
        shell: powershell
        run: |
          $maxAttempts = 3
          for ($i = 1; $i -le $maxAttempts; $i++) {
              Write-Host "==> Valheim Installation Versuch $i/$maxAttempts..."
              & C:\vtemp\steamcmd\steamcmd.exe `
                  +force_install_dir "C:\vtemp\valheim_ds" `
                  +login anonymous `
                  +app_update 896660 validate `
                  +quit

              if ($LASTEXITCODE -eq 0) {
                  Write-Host "==> Valheim erfolgreich installiert / aktualisiert"
                  break
              }

              if ($i -eq $maxAttempts) {
                  Write-Host "==> Valheim Installation fehlgeschlagen nach $maxAttempts Versuchen"
                  exit 1
              }

              Write-Host "==> Versuch fehlgeschlagen, warte 10 Sekunden und erneut..."
              Start-Sleep -Seconds 10
          }

      # 6️⃣ Mono.Cecil 0.11.4 herunterladen
      - name: Download Mono.Cecil
        shell: powershell
        run: |
          $cecilUrl = "https://www.nuget.org/api/v2/package/Mono.Cecil/0.11.4"
          $cecilPkg = "C:\vtemp\Mono.Cecil.nupkg"
          Invoke-WebRequest -Uri $cecilUrl -OutFile $cecilPkg
          Expand-Archive $cecilPkg -DestinationPath C:\vtemp\cecil

      # 7️⃣ DLL patchen mit deinem PS1 Script
      - name: Patch DLL
        shell: powershell
        run: ./Valheim-DLL.ps1

      # 8️⃣ Gepatchte DLL als Artefakt hochladen
      - name: Upload DLL
        uses: actions/upload-artifact@v4
        with:
          name: assembly_valheim
          path: assembly_valheim.dll
